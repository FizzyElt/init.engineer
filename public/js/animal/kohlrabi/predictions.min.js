const FUDGE_FACTOR=5,PATTERN={FLUCTUATING:0,LARGE_SPIKE:1,DECREASING:2,SMALL_SPIKE:3},PROBABILITY_MATRIX={[PATTERN.FLUCTUATING]:{[PATTERN.FLUCTUATING]:.2,[PATTERN.LARGE_SPIKE]:.3,[PATTERN.DECREASING]:.15,[PATTERN.SMALL_SPIKE]:.35},[PATTERN.LARGE_SPIKE]:{[PATTERN.FLUCTUATING]:.5,[PATTERN.LARGE_SPIKE]:.05,[PATTERN.DECREASING]:.2,[PATTERN.SMALL_SPIKE]:.25},[PATTERN.DECREASING]:{[PATTERN.FLUCTUATING]:.25,[PATTERN.LARGE_SPIKE]:.45,[PATTERN.DECREASING]:.05,[PATTERN.SMALL_SPIKE]:.25},[PATTERN.SMALL_SPIKE]:{[PATTERN.FLUCTUATING]:.45,[PATTERN.LARGE_SPIKE]:.25,[PATTERN.DECREASING]:.15,[PATTERN.SMALL_SPIKE]:.15}},RATE_MULTIPLIER=1e4;function intceil(e){return Math.trunc(e+.99999)}function minimum_rate_from_given_and_base(e,t){return RATE_MULTIPLIER*(e-.99999)/t}function maximum_rate_from_given_and_base(e,t){return RATE_MULTIPLIER*(e+1e-5)/t}function rate_range_from_given_and_base(e,t){return[minimum_rate_from_given_and_base(e,t),maximum_rate_from_given_and_base(e,t)]}function get_price(e,t){return intceil(e*t/RATE_MULTIPLIER)}function*multiply_generator_probability(e,t){for(const r of e)yield{...r,probability:r.probability*t}}function clamp(e,t,r){return Math.min(Math.max(e,t),r)}function range_length(e){return e[1]-e[0]}function range_intersect(e,t){return e[0]>t[1]||e[1]<t[0]?null:[Math.max(e[0],t[0]),Math.min(e[1],t[1])]}function range_intersect_length(e,t){return e[0]>t[1]||e[1]<t[0]?0:range_length(range_intersect(e,t))}function generate_individual_random_price(e,t,r,n,a,i){a*=RATE_MULTIPLIER,i*=RATE_MULTIPLIER;const _=e[0],s=[a,i];let o=1;for(let p=r;p<r+n;p++){let r=get_price(a,_),n=get_price(i,_);if(!isNaN(e[p])){if(e[p]<r-FUDGE_FACTOR||e[p]>n+FUDGE_FACTOR)return 0;o*=range_intersect_length(s,rate_range_from_given_and_base(clamp(e[p],r,n),_))/range_length(s),r=e[p],n=e[p]}t.push({min:r,max:n})}return o}class PDF{constructor(e,t,r=!0){this.value_start=Math.round(e),this.value_end=Math.round(t);const n=[e,t],a=range_length(n);if(this.prob=Array(this.value_end-this.value_start+1),r)for(let e=0;e<this.prob.length;e++)this.prob[e]=range_intersect_length(this.range_of(e),n)/a}range_of(e){return[this.value_start+e-.5,this.value_start+e+.5-1e-9]}min_value(){return this.value_start-.5}max_value(){return this.value_end+.5-1e-9}normalize(){const e=this.prob.reduce((e,t)=>e+t,0);for(let t=0;t<this.prob.length;t++)this.prob[t]/=e}range_limit(e){let[t,r]=e;if((t=Math.max(t,this.min_value()))>=(r=Math.min(r,this.max_value())))return this.value_start=this.value_end=0,this.prob=[],0;let n=0;const a=Math.round(t)-this.value_start,i=Math.round(r)-this.value_start;for(let t=a;t<=i;t++){const r=this.prob[t]*range_intersect_length(this.range_of(t),e);this.prob[t]=r,n+=r}return this.prob=this.prob.slice(a,i+1),this.value_start=Math.round(t),this.value_end=Math.round(r),this.normalize(),n}decay(e,t){const r=new PDF(this.min_value()-t,this.max_value()-e,!1);for(let e=1;e<this.prob.length;e++)this.prob[e]+=this.prob[e-1];const n=(e,t)=>((e-=this.value_start)<0&&(e=0),(t-=this.value_start)>this.prob.length&&(t=this.prob.length),e>=t?0:this.prob[t-1]-(0==e?0:this.prob[e-1]));for(let a=0;a<r.prob.length;a++)r.prob[a]=n(a+e+1+r.value_start,a+t+1+r.value_start),r.prob[a]+=n(a+e+r.value_start,a+t+r.value_start);this.prob=r.prob,this.value_start=r.value_start,this.value_end=r.value_end,this.normalize()}}function generate_decreasing_random_price(e,t,r,n,a,i,_,s){a*=RATE_MULTIPLIER,i*=RATE_MULTIPLIER,_*=RATE_MULTIPLIER,s*=RATE_MULTIPLIER;const o=e[0];let p=new PDF(a,i),l=1;for(let a=r;a<r+n;a++){let r=get_price(p.min_value(),o),n=get_price(p.max_value(),o);if(!isNaN(e[a])){if(e[a]<r-FUDGE_FACTOR||e[a]>n+FUDGE_FACTOR)return 0;const t=rate_range_from_given_and_base(clamp(e[a],r,n),o);if(0==(l*=p.range_limit(t)))return 0;r=e[a],n=e[a]}t.push({min:r,max:n}),p.decay(_,s)}return l}function generate_peak_price(e,t,r,n,a){n*=RATE_MULTIPLIER,a*=RATE_MULTIPLIER;const i=e[0];let _=1,s=[n,a];const o=e[r+1];if(!isNaN(o)){const e=get_price(n,i),t=get_price(a,i);if(o<e-FUDGE_FACTOR||o>t+FUDGE_FACTOR)return 0;const r=rate_range_from_given_and_base(clamp(o,e,t),i);if(0==(_*=range_intersect_length(s,r)/range_length(s)))return 0;s=range_intersect(s,r)}const p=e[r],l=e[r+2];for(const e of[p,l]){if(isNaN(e))continue;const t=get_price(n,i)-1,r=get_price(s[1],i)-1;if(e<t-FUDGE_FACTOR||e>r+FUDGE_FACTOR)return 0;const a=rate_range_from_given_and_base(clamp(e,t,r)+1,i),o=(e,t)=>e<=0?0:t<e?t:e-e*(Math.log(e)-Math.log(t)),[p,l]=s,m=n,c=p-m,u=l-m,g=e=>(o(e-m,u)-o(e-m,c))/(u-c);if(0==(_*=g(a[1])-g(a[0])))return 0}return min_pred=get_price(n,i)-1,max_pred=get_price(a,i)-1,isNaN(e[r])||(min_pred=e[r],max_pred=e[r]),t.push({min:min_pred,max:max_pred}),min_pred=t[r].min,max_pred=get_price(a,i),isNaN(e[r+1])||(min_pred=e[r+1],max_pred=e[r+1]),t.push({min:min_pred,max:max_pred}),min_pred=get_price(n,i)-1,max_pred=t[r+1].max-1,isNaN(e[r+2])||(min_pred=e[r+2],max_pred=e[r+2]),t.push({min:min_pred,max:max_pred}),_}function*generate_pattern_0_with_lengths(e,t,r,n,a,i){const _=e[0],s=[{min:_,max:_},{min:_,max:_}];let o=1;if(0==(o*=generate_individual_random_price(e,s,2,t,.9,1.4)))return;if(0==(o*=generate_decreasing_random_price(e,s,2+t,r,.6,.8,.04,.1)))return;if(0==(o*=generate_individual_random_price(e,s,2+t+r,n,.9,1.4)))return;if(0==(o*=generate_decreasing_random_price(e,s,2+t+r+n,a,.6,.8,.04,.1)))return;if(2+t+r+n+a+i!=14)throw new Error("Phase lengths don't add up");const p=2+t+r+n+a;0!=(o*=generate_individual_random_price(e,s,p,14-p,.9,1.4))&&(yield{pattern_description:"patterns.fluctuating",pattern_number:0,prices:s,probability:o})}function*generate_pattern_0(e){for(var t=2;t<4;t++)for(var r=0;r<7;r++)for(var n=0;n<7-r-1+1;n++)yield*multiply_generator_probability(generate_pattern_0_with_lengths(e,r,t,7-r-n,5-t,n),.5/7/(7-r))}function*generate_pattern_1_with_peak(e,t){const r=e[0],n=[{min:r,max:r},{min:r,max:r}];let a=1;if(0!=(a*=generate_decreasing_random_price(e,n,2,t-2,.85,.9,.03,.05))){min_randoms=[.9,1.4,2,1.4,.9,.4,.4,.4,.4,.4,.4],max_randoms=[1.4,2,6,2,1.4,.9,.9,.9,.9,.9,.9];for(let r=t;r<14;r++)if(0==(a*=generate_individual_random_price(e,n,r,1,min_randoms[r-t],max_randoms[r-t])))return;yield{pattern_description:"patterns.large-spike",pattern_number:1,prices:n,probability:a}}}function*generate_pattern_1(e){for(var t=3;t<10;t++)yield*multiply_generator_probability(generate_pattern_1_with_peak(e,t),1/7)}function*generate_pattern_2(e){const t=e[0],r=[{min:t,max:t},{min:t,max:t}];let n=1;0!=(n*=generate_decreasing_random_price(e,r,2,12,.85,.9,.03,.05))&&(yield{pattern_description:"patterns.decreasing",pattern_number:2,prices:r,probability:n})}function*generate_pattern_3_with_peak(e,t){const r=e[0],n=[{min:r,max:r},{min:r,max:r}];let a=1;0!=(a*=generate_decreasing_random_price(e,n,2,t-2,.4,.9,.03,.05))&&0!=(a*=generate_individual_random_price(e,n,t,2,.9,1.4))&&0!=(a*=generate_peak_price(e,n,t+2,1.4,2))&&(t+5<14&&0==(a*=generate_decreasing_random_price(e,n,t+5,14-(t+5),.4,.9,.03,.05))||(yield{pattern_description:"patterns.small-spike",pattern_number:3,prices:n,probability:a}))}function*generate_pattern_3(e){for(let t=2;t<10;t++)yield*multiply_generator_probability(generate_pattern_3_with_peak(e,t),1/8)}function get_transition_probability(e){return void 0===e||Number.isNaN(e)||null===e||e<0||e>3?[.346278,.247363,.147607,.258752]:PROBABILITY_MATRIX[e]}function*generate_all_patterns(e,t){const r=[generate_pattern_0,generate_pattern_1,generate_pattern_2,generate_pattern_3],n=get_transition_probability(t);for(let t=0;t<4;t++)yield*multiply_generator_probability(r[t](e),n[t])}function*generate_possibilities(e,t,r){if(t||isNaN(e[0]))for(var n=90;n<=110;n++)e[0]=e[1]=n,t?yield*generate_pattern_3(e):yield*generate_all_patterns(e,r);else yield*generate_all_patterns(e,r)}function analyze_possibilities(e,t,r){const n=Array.from(generate_possibilities(e,t,r));console.log(n);const a=n.reduce((e,t)=>e+t.probability,0);for(const e of n)e.probability/=a;for(let e of n){var i=[],_=[];for(let t of e.prices.slice(2))t.min!==t.max?(i.push(t.min),_.push(t.max)):(i=[],_=[]);i.length||_.length||(i.push(e.prices[e.prices.length-1].min),_.push(e.prices[e.prices.length-1].max)),e.weekGuaranteedMinimum=Math.max(...i),e.weekMax=Math.max(..._)}n.sort((e,t)=>e.weekMax<t.weekMax?1:e.weekMax>t.weekMax?-1:0),global_min_max=[];for(var s=0;s<14;s++){prices={min:999,max:0};for(let e of n)e.prices[s].min<prices.min&&(prices.min=e.prices[s].min),e.prices[s].max>prices.max&&(prices.max=e.prices[s].max);global_min_max.push(prices)}return n.unshift({pattern_description:"patterns.all",pattern_number:4,prices:global_min_max,weekGuaranteedMinimum:Math.min(...n.map(e=>e.weekGuaranteedMinimum)),weekMax:Math.max(...n.map(e=>e.weekMax))}),n}
